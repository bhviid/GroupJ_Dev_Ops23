@page "/{username}"
@inject HttpClient http
@inject NavigationManager navigation

<h2>@username timeline</h2>

@if (User is not null)
{
    <div class=followstatus>
        @if(User.Username == username)
        {
            <span>this is you!</span>
        }
        else 
        {
            if(Followed)
            {
                <span>You are currently following this user.</span>
                <a class=unfollow @onclick="HandleUnFollow">
                    Unfollow user
                </a>
            }
            else 
            {
                <span>You are not yet following this user.</span>
                <a class=follow @onclick="HandleFollow">
                    Follow user
                </a>
            }
        }
    </div>
}
<TwitDisplayer TwitData="TwitData" Gravatars="gravatars" />

@code 
{
    [CascadingParameter]
    public User? User {get; set;}

    public bool Followed { get; set; }

    [Parameter]
    public string? username { get; set; }

    public List<MsgDataPair> TwitData { get; set; } = new List<MsgDataPair>();
    private Dictionary<string, string> gravatars = new Dictionary<string, string>();
    private int gravatarSize = 48;

    protected override async Task OnInitializedAsync()
    {
        var httpRes = await http.GetAsync($"/minitwit/{username}");

        if(!httpRes.IsSuccessStatusCode)
        {
            navigation.NavigateTo("/public");
            return;
        }
        var res = await httpRes.Content.ReadFromJsonAsync<MsgDataPair[]>();

        if(User is not null)
        {
            Followed = await http.GetFromJsonAsync<bool>($"/minitwit/is-follower/{User.Username}/{username}");
        }
        //MsgDataPair[] res = await http.GetFromJsonAsync<MsgDataPair[]>($"/minitwit/{username}");   
  
        
        foreach(var m in res!)
        {
            var authormail = m.Author.email;
            gravatars[authormail] = await http.GetStringAsync($"/minitwit/md5/{authormail}/{gravatarSize}");
        }
        TwitData = res!.ToList();
    }

    private async Task HandleFollow()
    {
        var resp = await http.PostAsJsonAsync<User>($"/minitwit/{username}/follow", User);
        if(resp.IsSuccessStatusCode)
        {
            //Tell the user that they are indeed following the user...
            Followed = true;
        }
        else
        {
            //Alert user that something went wrong?
        }
    }

    private async Task HandleUnFollow()
    {
        var resp = await http.PostAsJsonAsync<User>($"/minitwit/{username}/unfollow", User);

        if(resp.IsSuccessStatusCode)
        {
            //Tell the user that they are indeed following the user...
            Followed = false;
        }
        else
        {
            //Alert user that something went wrong?
        }
    }
}