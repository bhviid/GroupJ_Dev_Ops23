@page "/login"
@inject HttpClient http
@inject NavigationManager navigation
@inject UserService uService

<h2>Sign In</h2>
@if(ErrorMessage is not null)
{
    <div class=error>
        <strong>Error:</strong> @ErrorMessage
    </div>
}    
<EditForm Model="@_model" OnSubmit="@HandleLoginSubmit">
<dl>
    <dt>Username:</dt>
    <dd>
    <input type=text name=username size=30 @bind-value="_model.Username" />
    </dd>
    <dt>Password:</dt>
    <dd>
    <input type=password name=password size=30 @bind-value="_model.Password">
    </dd>
</dl>
<div class=actions>
    <input type=submit value="Sign In">
</div>
</EditForm>

@code
{
    private LoginModel _model = new();
    public string ErrorMessage { get; set; }

    private async void HandleLoginSubmit()
    {
        UserLoginDTO toPost = new(_model.Username, _model.Password);

        var resp = await http.PostAsJsonAsync<UserLoginDTO>("/minitwit/login", toPost);
        
        if(!resp.IsSuccessStatusCode)
        {
            // his only shows when hitting the sign in button a second time ???
            ErrorMessage = resp.ReasonPhrase;
        }

        //var userToSignIn = resp.Content.ReadFromJsonAsync<UserDTO>();
        var userToSignIn = new User{UserId = 1, Username = "Roger Histand", Email ="billy@example.com"};
        uService.ActiveUser = userToSignIn;
    }
}

